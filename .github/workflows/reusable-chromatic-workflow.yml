name: "Reusable Chromatic Visual Regression Testing"

on:
  workflow_call:
    inputs:
      chromatic-project-token-secret-name:
        description: "Name of the Chromatic project token secret in Azure Key Vault"
        required: true
        type: string

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  chromatic:
    name: Run Chromatic
    runs-on: [idp]
    environment: ci

    steps:
      - name: Get Secrets from Azure Key Vault
        id: get_chromatic_project_token
        uses: workleap/wl-reusable-workflows/retrieve-managed-secret@main
        with:
          azure-client-id: ${{ vars.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ vars.AZURE_TENANT_ID }}
          azure-subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}
          keyvault-name: ${{ vars.KEYVAULT_NAME }}
          secret-name: ${{ inputs.chromatic-project-token-secret-name }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Chromatic
        id: chromatic
        continue-on-error: true
        uses: chromaui/action@latest
        with:
          projectToken: ${{ steps.get_chromatic_project_token.outputs.secret }}
          onlyChanged: true
          autoAcceptChanges: main
          exitZeroOnChanges: false
        env:
          CHROMATIC_DEBUG: true

      - name: Write to GitHub comment
        if: always() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v3
        with:
          comment-tag: chromatic_build_url
          message: |
            ### Chromatic Results

            üìñ [View Storybook](${{ steps.chromatic.outputs.storybookUrl && steps.chromatic.outputs.storybookUrl != '' && steps.chromatic.outputs.storybookUrl || 'N/A' }})
            üîç [View Chromatic Build](${{ steps.chromatic.outputs.buildUrl && steps.chromatic.outputs.buildUrl != '' && steps.chromatic.outputs.buildUrl || 'N/A' }})

            **Status:** ${{
              steps.chromatic.outputs.code == '0' && '‚úÖ No visual changes detected' ||
              steps.chromatic.outputs.code == '1' && '‚ö†Ô∏è Visual changes detected - requires approval' ||
              steps.chromatic.outputs.code == '2' && '‚ùå Build has component errors' ||
              steps.chromatic.outputs.code == '3' && '‚ùå Build failed due to system error' ||
              (!steps.chromatic.outputs.code || steps.chromatic.outputs.code == '') && '‚ùå Chromatic did not run successfully or outputs are missing' ||
              format('‚ùì Unknown error (exit code: {0}) - [See documentation](https://www.chromatic.com/docs/cli/#exit-codes)', steps.chromatic.outputs.code)
            }}
