name: Test Jira Branch Pattern

on:
  pull_request:
    paths:
      - 'extract-jira-issue/action.yml'
      - '.github/workflows/reusable-jira-workflow-tests.yml'
  workflow_dispatch:

jobs:
  test-branch-pattern:
    runs-on: ubuntu-latest
    name: Jira Branch Pattern Tests
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        include:
          # Valid Jira patterns - should match
          - branch: "SGPD-3684"
            expected_match: "true"
            expected_jira: "SGPD-3684"
          - branch: "SGPD-123_something"
            expected_match: "true"
            expected_jira: "SGPD-123"
          - branch: "feature/PROJ-123"
            expected_match: "true"
            expected_jira: "PROJ-123"
          - branch: "bugfix/ABC-456"
            expected_match: "true"
            expected_jira: "ABC-456"
          - branch: "hotfix/XY-789"
            expected_match: "true"
            expected_jira: "XY-789"
          - branch: "feature/SGPD-3684-update-branch-pattern"
            expected_match: "true"
            expected_jira: "SGPD-3684"
          - branch: "chore/A1B2-999-cleanup"
            expected_match: "true"
            expected_jira: "A1B2-999"

          # GitHub revert patterns - should match and extract the Jira issue
          - branch: "revert-456-feature-GHI-789"
            expected_match: "true"
            expected_jira: "GHI-789"
          - branch: "revert-123-feature/sub/JKL-012"
            expected_match: "true"
            expected_jira: "JKL-012"
          - branch: "revert-123-feature/sub/JKL-012_more_branch_naming"
            expected_match: "true"
            expected_jira: "JKL-012"
          - branch: "revert-1970-SGPD-3662_swallow_job_error"
            expected_match: "true"
            expected_jira: "SGPD-3662"
          - branch: "feature/SGPD-3645_deploy-multi-region-dev-2"
            expected_match: "true"
            expected_jira: "SGPD-3645"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Test Jira Extraction
      id: extract
      uses: ./extract-jira-issue
      with:
        branch_name: ${{ matrix.branch }}
        
    - name: Validate Result
      shell: pwsh
      env:
        BranchName: "${{ matrix.branch }}"
        ExpectedMatch: "${{ matrix.expected_match }}"
        ExpectedJira: "${{ matrix.expected_jira }}"
        FoundMatches: "${{steps.extract.outputs.matches}}"
        JiraKeyMatches: "${{steps.extract.outputs.jira_issue_matches}}"
      run: |
        Write-Host "Testing branch: $env:BranchName"
        Write-Host "Expected match: $env:ExpectedMatch"
        Write-Host "Expected Jira: '$env:ExpectedJira'"
        Write-Host "Jira matches: '$env:JiraKeyMatches'"
        
        $success = $true
        
        if ($env:FoundMatches -ne $env:ExpectedMatch) {
          Write-Host "❌ FAIL: Match result mismatch"
          $success = $false
        }
        
         # Check if any match equals expectedJira
        $foundMatch = $false
        if ($env:JiraKeyMatches) {

          $matchArray = $env:JiraKeyMatches | ConvertFrom-Json
          
          Write-Host "Found $($matchArray.Count) match(es) in output"
          
          foreach ($match in $matchArray) {
            Write-Host "  Checking match: '$match'"
            if ($match -eq $env:ExpectedJira) {
              Write-Host "  ✅ Found matching Jira issue: '$match'"
              $foundMatch = $true
              break
            }
          }
        }
        
        if (-not $foundMatch) {
          Write-Host "❌ FAIL: Expected Jira issue '$env:ExpectedJira' not found in matches"
          $success = $false
        }
        
        if ($success) {
          Write-Host "✅ PASS: Test successful"
        } else {
          exit 1
        }

  test-workflow-jira:
    uses: ./.github/workflows/reusable-jira-workflow.yml
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    with:
      branch_name: "feature/SGPD-3645_deploy-multi-region-dev-2"
      is_CI: true